[在高并发业务场景下，保护系统时，常用的"三板斧"有："熔断、降级和限流"。]

今天和大家谈谈常用的限流算法的几种实现方式，

这里所说的限流并非是网关层面的限流，而是业务代码中的逻辑限流
限流算法常用的几种实现方式有如下四种：
* 计数器
* 滑动窗口
* 漏桶
* 令牌桶

下面会展开说每种算法的实现原理和他们自身的缺陷，方便以后我们在实际应用中能够根据不同的情况选择正确的限流算法。

【计数器】

算法思想：
计数器是一种比较简单粗暴的限流算法，其思想是在固定时间窗口内对请求进行计数，
与阀值进行比较判断是否需要限流，一旦到了时间临界点，将计数器清零。

面临的问题：
计数器算法存在“时间临界点”缺陷。(时间窗每经过1s就会重置计数，就无法识别到这种请求超限)
比如每一分钟限制100个请求，可以在00:00:00-00:00:58秒里面都没有请求，在00:00:59瞬间发送100个请求，
这个对于计数器算法来是允许的，然后在00:01:00再次发送100个请求，意味着在短短1s内发送了200个请求，
如果量更大呢，系统可能会承受不住瞬间流量，导致系统崩溃。（如下图所示）

所以计数器算法实现限流的问题是没有办法应对突发流量，不过它的算法实现起来确实最简单的，
下面给出一个用Go代码实现的计数器。
【代码实现】
counter.go
    
     

---
[滑动窗口]是时间普通时间窗口将滑动的粒度降低了，从每秒滑动一次到每100毫秒滑动一次。

滑动窗口算法将一个大的时间窗口分成多个小窗口，每次大窗口向后滑动一个小窗口，
并保证大的窗口内流量不会超出最大值，这种实现比固定窗口的流量曲线更加平滑。

普通时间窗口有一个问题，比如窗口期内请求的上限是100，假设有100个请求集中在前1s的后100ms，
100个请求集中在后1s的前100ms，其实在这200ms内就已经请求超限了，
但是由于时间窗每经过1s就会重置计数，就无法识别到这种请求超限。

对于滑动时间窗口，我们可以把1ms的时间窗口划分成10个小窗口，或者想象窗口有10个时间插槽time slot, 
每个time slot统计某个100ms的请求数量。每经过100ms，有一个新的time slot加入窗口，
早于当前时间1s的time slot出窗口。窗口内最多维护10个time slot。

【面临的问题】
滑动窗口算法是固定窗口的一种改进，但从根本上并没有真正解决固定窗口算法的临界突发流量问题

【代码实现】
主要就是实现滑动窗口算法，不过滑动窗口算法一般是找出数组中连续k个元素的最大值，
这里是已知最大值n (就是请求上限）如果超过最大值就不予通过。

可以参考Bilibili开源的kratos框架里circuit breaker用循环列表保存timeSlot对象的实现，
他们这个实现的好处是不用频繁的创建和销毁timeslot对象。（对象的重复使用可以减少因为频繁创建和销毁而造成的开销）
下面给出一个简单的基本实现： slideWindow.go


[漏桶]

算法思想:
漏桶算法是首先想象有一个木桶，桶的容量是固定的。当有请求到来时先放到木桶中，
处理请求的worker(以固定的速度)从木桶中取出请求进行相应。

如果木桶已经满了，直接返回请求频率超限的错误码或者页面。

[适用场景]
漏桶算法是流量最均匀的限流实现方式，
一般用于流量“整形”。
例如保护数据库的限流:
先把对数据库的访问加入到木桶中，worker再以db能够承受的qps从木桶中取出请求，去访问数据库。

[存在的问题]
木桶流入请求的速率是不固定的， 但是流出的速率是恒定的。
这样的话能保护系统资源不被打满，但是面对突发流量时会有大量请求失败，
不适合电商抢购和微博出现热点事件等场景的限流。

[代码实现] bucket.go

---

[令牌桶]
算法思想:
令牌桶是反向的"漏桶"，它是以恒定的速度往木桶里加入令牌，木桶满了则不再加入令牌。
服务收到请求时尝试从木桶中取出一个令牌，如果能够得到令牌则继续执行后续的业务逻辑。
如果没有得到令牌，直接返回访问频率超限的错误码或页面等，不继续执行后续的业务逻辑。
特点：由于木桶内只要有令牌，请求就可以被处理，所以令牌桶算法可以支持突发流量

同时由于往木桶添加令牌的速度是恒定的，且木桶的容量有上限，所以单位时间内处理的请求书也能够得到控制，起到限流的目的。假设加入令牌的速度为 1token/10ms，桶的容量为500，在请求比较的少的时候（小于每10毫秒1个请求）时，木桶可以先"攒"一些令牌（最多500个）。当有突发流量时，一下把木桶内的令牌取空，也就是有500个在并发执行的业务逻辑，之后要等每10ms补充一个新的令牌才能接收一个新的请求。

[参数设置:]
木桶的容量  - 考虑业务逻辑的资源消耗和机器能承载并发处理多少业务逻辑。
生成令牌的速度 - 太慢的话起不到“攒”令牌应对突发流量的效果。

[适用场景]
适合电商抢购或者微博出现热点事件这种场景，因为在限流的同时可以应对一定的突发流量。
如果采用漏桶那样的均匀速度处理请求的算法，在发生热点时间的时候，会造成大量的用户无法访问，
对用户体验的损害比较大。

[代码实现]tokens




    

